<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aplikasi Absensi Terintegrasi</title>
    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap Icons -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">
    <style>
        body { background-color: #f4f7f6; }
        .card-custom { border-radius: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.05); border: none; }
        .bg-primary-custom { background: linear-gradient(135deg, #0d6efd, #0b5ed7); }
        #appContainer { display: none; } /* Disembunyikan sampai login sukses */
        #loadingOverlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255,255,255,0.8); z-index: 1050; display: none;
            justify-content: center; align-items: center; flex-direction: column;
        }
        .nav-pills .nav-link { border-radius: 50px; margin-right: 10px; color: #495057; font-weight: 500;}
        .nav-pills .nav-link.active { background-color: #0d6efd; color: white; }
        .table-responsive { font-size: 0.9rem; }
    </style>
</head>
<body>

    <!-- Loading Overlay -->
    <div id="loadingOverlay">
        <div class="spinner-border text-primary" role="status" style="width: 3rem; height: 3rem;"></div>
        <h5 class="mt-3 text-secondary" id="loadingText">Memuat Data...</h5>
    </div>

    <!-- Global Alert Modal -->
    <div class="modal fade" id="globalAlertModal" tabindex="-1">
        <div class="modal-dialog modal-sm modal-dialog-centered">
            <div class="modal-content border-0 shadow">
                <div class="modal-header bg-danger text-white border-0 py-2">
                    <h6 class="modal-title fw-bold"><i class="bi bi-exclamation-triangle-fill me-1"></i> Perhatian</h6>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body text-center py-4 text-dark" id="globalAlertText" style="font-size: 0.95rem;">
                    <!-- Message goes here -->
                </div>
                <div class="modal-footer justify-content-center border-0 pt-0">
                    <button type="button" class="btn btn-secondary btn-sm px-4 rounded-pill" data-bs-dismiss="modal">Tutup</button>
                </div>
            </div>
        </div>
    </div>

    <div class="container py-4 sm:py-5 min-vh-100 d-flex flex-column justify-content-center align-items-center">
        
        <!-- ========================================== -->
        <!-- BAGIAN 1: FORM LOGIN -->
        <!-- ========================================== -->
        <div id="loginContainer" class="w-100" style="max-width: 400px;">
            <div class="card card-custom overflow-hidden">
                <div class="card-body p-4 p-sm-5">
                    <div class="text-center mb-4">
                        <i class="bi bi-person-circle text-primary" style="font-size: 4rem;"></i>
                        <h3 class="fw-bold mt-2">Login Portal</h3>
                        <p class="text-muted small">Silakan masuk untuk melanjutkan</p>
                    </div>
                    
                    <form id="loginForm">
                        <div class="form-floating mb-3">
                            <input type="text" class="form-control" id="username" placeholder="Username" required>
                            <label for="username">Username</label>
                        </div>
                        <div class="form-floating mb-4">
                            <input type="password" class="form-control" id="password" placeholder="Password" required>
                            <label for="password">Password</label>
                        </div>
                        
                        <div id="loginError" class="alert alert-danger d-none py-2 text-center small"></div>
                        
                        <button type="submit" class="btn btn-primary w-100 py-3 fw-bold rounded-3" id="btnLogin">
                            <i class="bi bi-box-arrow-in-right me-2"></i> Masuk
                        </button>
                    </form>
                </div>
            </div>
        </div>

        <!-- ========================================== -->
        <!-- BAGIAN 2: MAIN APP (DASHBOARD) -->
        <!-- ========================================== -->
        <div id="appContainer" class="w-100" style="max-width: 950px;">
            
            <!-- ADMIN NAVIGATION TABS -->
            <ul class="nav nav-pills mb-4" id="adminTabs" style="display: none;">
                <li class="nav-item" id="li-tab-data-absen">
                    <a class="nav-link" id="tab-data-absen" href="#" onclick="switchTab('data-absen')"><i class="bi bi-card-list me-1"></i> Data Absensi</a>
                </li>
                <li class="nav-item" id="li-tab-karyawan">
                    <a class="nav-link" id="tab-karyawan" href="#" onclick="switchTab('karyawan')"><i class="bi bi-people me-1"></i> Data Karyawan</a>
                </li>
                <li class="nav-item" id="li-tab-login">
                    <a class="nav-link" id="tab-login" href="#" onclick="switchTab('login')"><i class="bi bi-shield-lock me-1"></i> Akun Login</a>
                </li>
            </ul>

            <div class="card card-custom overflow-hidden">
                <!-- Header Global -->
                <div class="bg-primary-custom text-white p-4">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h4 class="fw-bold mb-0" id="headerTitle">Formulir Absensi</h4>
                            <small id="userRoleBadge" class="badge bg-light text-primary mt-1">Role</small>
                        </div>
                        <button type="button" class="btn btn-sm btn-outline-light" onclick="logout()">
                            <i class="bi bi-power"></i> Keluar
                        </button>
                    </div>
                </div>

                <div class="card-body p-4 p-sm-5">
                    
                    <!-- TAB 1: FORM ABSENSI (Hanya untuk User Karyawan) -->
                    <div id="sec-absen" class="d-none">
                        <form id="absenForm">
                            <!-- Pencarian Nama Karyawan -->
                            <div class="mb-4 p-3 bg-light rounded border border-primary-subtle">
                                <label class="form-label fw-bold text-primary">Nama Karyawan</label>
                                <input type="text" id="nama" class="form-control form-control-lg border-primary" list="namaList" placeholder="Ketik atau pilih Nama Anda" required autocomplete="off">
                                <datalist id="namaList"></datalist>
                                <div class="form-text text-muted small"><i class="bi bi-info-circle"></i> Ketik Nama untuk mengisi data otomatis.</div>
                            </div>
                            <!-- Data Diri Auto-fill -->
                            <div class="row g-3 mb-4 d-none"> <!-- Menyembunyikan baris ID/Badge -->
                                <div class="col-md-12">
                                    <label class="form-label text-muted small mb-1">ID / Badge Karyawan</label>
                                    <input type="text" id="Badge" class="form-control bg-light" readonly required>
                                </div>
                            </div>
                            <div class="row g-3 mb-4">
                                <div class="col-md-6">
                                    <label class="form-label text-muted small mb-1">Jabatan</label>
                                    <input type="text" id="Jabatan" class="form-control bg-light" readonly required>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label text-muted small mb-1">No HP</label>
                                    <input type="text" id="no_hp" class="form-control bg-light" readonly required>
                                </div>
                            </div>
                            <!-- Status Absensi Dropdown -->
                            <div class="mb-4">
                                <label class="form-label fw-bold">Status Kehadiran</label>
                                <select id="Status_Absensi" class="form-select form-select-lg" required>
                                    <option value="" disabled selected>-- Pilih Status --</option>
                                </select>
                            </div>
                            <!-- Lokasi GPS -->
                            <div class="mb-4">
                                <div class="d-flex justify-content-between align-items-center mb-2">
                                    <label class="form-label fw-bold mb-0">Titik Koordinat Lokasi (GPS)</label>
                                    <button type="button" class="btn btn-sm btn-outline-primary" onclick="getLocation()">
                                        <i class="bi bi-geo-alt-fill"></i> Ambil Lokasi
                                    </button>
                                </div>
                                <div class="row g-2">
                                    <div class="col-6">
                                        <input type="text" id="Latitude" class="form-control text-center" placeholder="Latitude" readonly required>
                                    </div>
                                    <div class="col-6">
                                        <input type="text" id="Langtitude" class="form-control text-center" placeholder="Longitude" readonly required>
                                    </div>
                                </div>
                                <div id="locationStatus" class="form-text mt-2 d-none"></div>
                            </div>
                            <hr class="my-4">
                            <!-- Tombol Submit -->
                            <button type="submit" id="btnSubmitAbsen" class="btn btn-success w-100 py-3 fw-bold rounded-3 shadow-sm">
                                <i class="bi bi-send-check me-2"></i> Kirim Data Absensi
                            </button>
                            <div id="statusMessage" class="alert d-none mt-3 text-center" role="alert"></div>
                        </form>
                    </div>

                    <!-- TAB DATA ABSENSI (Hanya untuk Super Admin) -->
                    <div id="sec-data-absen" class="d-none">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h5 class="fw-bold mb-0">Data Rekap Absensi</h5>
                            <button class="btn btn-outline-primary btn-sm" onclick="fetchAdminData()"><i class="bi bi-arrow-clockwise"></i> Segarkan Data</button>
                        </div>
                        <div class="table-responsive">
                            <table class="table table-bordered table-hover align-middle">
                                <thead class="table-light">
                                    <tr>
                                        <th>Waktu Absen</th>
                                        <th>Badge</th>
                                        <th>Nama Karyawan</th>
                                        <th>Jabatan</th>
                                        <th>Status</th>
                                        <th>Lokasi</th>
                                    </tr>
                                </thead>
                                <tbody id="tbodyAbsensi">
                                    <!-- Terisi via JS -->
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- TAB 2: KELOLA KARYAWAN (Hanya untuk Admin/Superadmin) -->
                    <div id="sec-karyawan" class="d-none">
                        <div class="d-flex justify-content-between mb-3">
                            <h5 class="fw-bold">Manajemen Karyawan</h5>
                            <button class="btn btn-primary btn-sm" onclick="openModalKaryawan('add')"><i class="bi bi-plus-lg"></i> Tambah Karyawan</button>
                        </div>
                        <div class="table-responsive">
                            <table class="table table-bordered table-hover align-middle">
                                <thead class="table-light">
                                    <tr>
                                        <th>Badge</th>
                                        <th>Nama</th>
                                        <th>Jabatan</th>
                                        <th>No HP</th>
                                        <th>Aksi</th>
                                    </tr>
                                </thead>
                                <tbody id="tbodyKaryawan">
                                    <!-- Terisi via JS -->
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- TAB 3: KELOLA LOGIN (Hanya untuk Superadmin) -->
                    <div id="sec-login" class="d-none">
                        <div class="d-flex justify-content-between mb-3">
                            <h5 class="fw-bold">Manajemen Akses Login</h5>
                            <button class="btn btn-primary btn-sm" onclick="openModalLogin('add')"><i class="bi bi-plus-lg"></i> Tambah Akun</button>
                        </div>
                        <div class="table-responsive">
                            <table class="table table-bordered table-hover align-middle">
                                <thead class="table-light">
                                    <tr>
                                        <th>ID Login</th>
                                        <th>Username</th>
                                        <th>Password</th>
                                        <th>Role / Keterangan</th>
                                        <th>Aksi</th>
                                    </tr>
                                </thead>
                                <tbody id="tbodyLogin">
                                    <!-- Terisi via JS -->
                                </tbody>
                            </table>
                        </div>
                    </div>

                </div>
            </div>
        </div>
    </div>

    <!-- ========================================== -->
    <!-- MODAL FORM KARYAWAN -->
    <!-- ========================================== -->
    <div class="modal fade" id="modalKaryawan" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title" id="modalKaryawanTitle">Tambah Karyawan</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="formKaryawan">
                        <input type="hidden" id="kar_action_method">
                        <input type="hidden" id="kar_old_badge">
                        <div class="mb-2">
                            <label class="form-label small">ID Badge</label>
                            <input type="text" class="form-control form-control-sm" id="kar_badge" required>
                        </div>
                        <div class="mb-2">
                            <label class="form-label small">Nama Karyawan</label>
                            <input type="text" class="form-control form-control-sm" id="kar_nama" required>
                        </div>
                        <div class="row">
                            <div class="col-6 mb-2">
                                <label class="form-label small">Jenis Kelamin</label>
                                <select class="form-select form-select-sm" id="kar_jk">
                                    <option value="Laki-laki">Laki-laki</option>
                                    <option value="Perempuan">Perempuan</option>
                                </select>
                            </div>
                            <div class="col-6 mb-2">
                                <label class="form-label small">Status Kerja</label>
                                <input type="text" class="form-control form-control-sm" id="kar_statusKerja" placeholder="Karyawan/Kontrak">
                            </div>
                            <div class="col-6 mb-2">
                                <label class="form-label small">Jabatan</label>
                                <input type="text" class="form-control form-control-sm" id="kar_jabatan" required>
                            </div>
                            <div class="col-6 mb-2">
                                <label class="form-label small">Status Pernikahan</label>
                                <select class="form-select form-select-sm" id="kar_statusNikah">
                                    <option value="Menikah">Menikah</option>
                                    <option value="Belum Menikah">Belum Menikah</option>
                                </select>
                            </div>
                            <div class="col-6 mb-2">
                                <label class="form-label small">NIK KTP</label>
                                <input type="text" class="form-control form-control-sm" id="kar_nik">
                            </div>
                            <div class="col-6 mb-2">
                                <label class="form-label small">No KK</label>
                                <input type="text" class="form-control form-control-sm" id="kar_kk">
                            </div>
                            <!-- Update Kolom Foto KTP untuk menggunakan Kamera/File -->
                            <div class="col-6 mb-2">
                                <label class="form-label small">Foto KTP</label>
                                <!-- capture="environment" untuk otomatis buka kamera belakang jika di HP -->
                                <input type="file" class="form-control form-control-sm" id="kar_fotoKtp_file" accept="image/*" capture="environment">
                                <input type="hidden" id="kar_fotoKtp_base64">
                                <div id="kar_fotoKtp_preview" class="mt-1 small d-none"></div>
                            </div>
                            <!-- Update Kolom Foto KK untuk menggunakan Kamera/File -->
                            <div class="col-6 mb-2">
                                <label class="form-label small">Foto KK</label>
                                <input type="file" class="form-control form-control-sm" id="kar_fotoKk_file" accept="image/*" capture="environment">
                                <input type="hidden" id="kar_fotoKk_base64">
                                <div id="kar_fotoKk_preview" class="mt-1 small d-none"></div>
                            </div>
                            <div class="col-6 mb-2">
                                <label class="form-label small">No HP</label>
                                <input type="text" class="form-control form-control-sm" id="kar_hp">
                            </div>
                            <div class="col-6 mb-2">
                                <label class="form-label small">Keterangan</label>
                                <input type="text" class="form-control form-control-sm" id="kar_ket">
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary btn-sm" data-bs-dismiss="modal">Batal</button>
                    <button type="button" class="btn btn-primary btn-sm" onclick="saveKaryawan()">Simpan Data</button>
                </div>
            </div>
        </div>
    </div>

    <!-- ========================================== -->
    <!-- MODAL FORM LOGIN -->
    <!-- ========================================== -->
    <div class="modal fade" id="modalLogin" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header bg-dark text-white">
                    <h5 class="modal-title" id="modalLoginTitle">Tambah Akun Login</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="formLogin">
                        <input type="hidden" id="log_action_method">
                        <input type="hidden" id="log_old_id">
                        <div class="mb-3">
                            <label class="form-label small">ID Login</label>
                            <input type="text" class="form-control" id="log_id" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label small">Username</label>
                            <input type="text" class="form-control" id="log_username" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label small">Password</label>
                            <input type="text" class="form-control" id="log_password" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label small">Role Akses</label>
                            <select class="form-select" id="log_role" required>
                                <option value="Super Admin">Super Admin</option>
                                <option value="Admin">Admin</option>
                                <option value="User Karyawan">User Karyawan</option>
                            </select>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Batal</button>
                    <button type="button" class="btn btn-dark" onclick="saveLogin()">Simpan Akun</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap 5 JS Bundle (with Popper) -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        // GANTI URL INI JIKA ANDA MEMBUAT DEPLOYMENT BARU DI APPS SCRIPT
        const scriptURL = 'https://script.google.com/macros/s/AKfycbwmBVKAgekX36MHBHjBVxa82yNP1jCD79BjnunQI6ZGHZdYssozA6lDQgtUWtmNUuqiAA/exec'; 
        
        let globalKaryawanList = [];
        let adminKaryawanData = [];
        let adminLoginData = [];
        let adminAbsensiData = []; // Variabel untuk menampung data absensi
        let currentUserRole = '';

        const overlay = document.getElementById('loadingOverlay');
        const loadingText = document.getElementById('loadingText');

        // Inisialisasi Modals
        const mkModal = new bootstrap.Modal(document.getElementById('modalKaryawan'));
        const mlModal = new bootstrap.Modal(document.getElementById('modalLogin'));
        const gaModal = new bootstrap.Modal(document.getElementById('globalAlertModal'));

        // Pengganti Alert Bawaan Browser
        function showAlert(msg) {
            document.getElementById('globalAlertText').textContent = msg;
            gaModal.show();
        }

        function showLoading(text) {
            loadingText.textContent = text;
            overlay.style.display = 'flex';
        }
        function hideLoading() {
            overlay.style.display = 'none';
        }

        // ==========================================
        // PROSES KOMPRESI GAMBAR KAMERA (Baru)
        // ==========================================
        // Fitur ini otomatis mengecilkan foto agar muat disimpan di sel Google Sheet
        function processImage(file, hiddenInputId, previewId) {
            if (!file) return;
            
            const preview = document.getElementById(previewId);
            preview.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Memproses...';
            preview.classList.remove('d-none', 'text-success');
            preview.classList.add('text-primary');

            const reader = new FileReader();
            reader.readAsDataURL(file);
            reader.onload = function(event) {
                const img = new Image();
                img.src = event.target.result;
                img.onload = function() {
                    const canvas = document.createElement('canvas');
                    const MAX_WIDTH = 500; // Kompresi maksimal lebar 500px agar tidak melebihi batas G-Sheet
                    let width = img.width;
                    let height = img.height;

                    if (width > MAX_WIDTH) {
                        height = height * (MAX_WIDTH / width);
                        width = MAX_WIDTH;
                    }

                    canvas.width = width;
                    canvas.height = height;
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0, width, height);
                    
                    // Simpan sebagai JPEG format teks base64
                    const dataUrl = canvas.toDataURL('image/jpeg', 0.5);
                    document.getElementById(hiddenInputId).value = dataUrl;
                    
                    preview.innerHTML = '<i class="bi bi-check-circle-fill"></i> Foto siap disimpan';
                    preview.classList.remove('text-primary');
                    preview.classList.add('text-success');
                }
            };
        }

        document.getElementById('kar_fotoKtp_file').addEventListener('change', function(e) {
            processImage(e.target.files[0], 'kar_fotoKtp_base64', 'kar_fotoKtp_preview');
        });

        document.getElementById('kar_fotoKk_file').addEventListener('change', function(e) {
            processImage(e.target.files[0], 'kar_fotoKk_base64', 'kar_fotoKk_preview');
        });


        // ==========================================
        // UI HELPERS (TABS)
        // ==========================================
        function switchTab(tabName) {
            document.querySelectorAll('.nav-pills .nav-link').forEach(el => el.classList.remove('active'));
            const activeTab = document.getElementById('tab-' + tabName);
            if(activeTab) activeTab.classList.add('active'); 

            document.getElementById('sec-absen').classList.add('d-none');
            document.getElementById('sec-karyawan').classList.add('d-none');
            document.getElementById('sec-login').classList.add('d-none');
            document.getElementById('sec-data-absen').classList.add('d-none'); // Sembunyikan data absen

            document.getElementById('sec-' + tabName).classList.remove('d-none');

            if(tabName === 'absen') document.getElementById('headerTitle').textContent = 'Formulir Absensi';
            if(tabName === 'karyawan') document.getElementById('headerTitle').textContent = 'Manajemen Karyawan';
            if(tabName === 'login') document.getElementById('headerTitle').textContent = 'Manajemen Akses';
            if(tabName === 'data-absen') document.getElementById('headerTitle').textContent = 'Laporan Data Absensi';
        }

        // ==========================================
        // 1. SISTEM LOGIN DENGAN PENGATURAN ROLE BARU
        // ==========================================
        document.getElementById('loginForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const btn = document.getElementById('btnLogin');
            const errorDiv = document.getElementById('loginError');
            
            btn.disabled = true;
            btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Memeriksa...';
            errorDiv.classList.add('d-none');

            const payload = {
                action: 'login',
                username: document.getElementById('username').value,
                password: document.getElementById('password').value
            };

            try {
                const response = await fetch(scriptURL, { 
                    method: 'POST', 
                    headers: { 'Content-Type': 'text/plain;charset=utf-8' },
                    body: JSON.stringify(payload) 
                });
                const result = await response.json();

                if (result.status === "success") {
                    currentUserRole = result.user.role;
                    document.getElementById('userRoleBadge').textContent = "Akses: " + currentUserRole;
                    document.getElementById('loginContainer').style.display = 'none';
                    document.getElementById('appContainer').style.display = 'block';
                    
                    // PENYESUAIAN ROLE TERBARU: 
                    // Super Admin: Data Absensi, Data Karyawan, Login
                    // Admin: Hanya Data Karyawan
                    // User: Hanya Form Absensi
                    if (currentUserRole === 'Super Admin') {
                        document.getElementById('adminTabs').style.display = 'flex';
                        document.getElementById('li-tab-data-absen').style.display = 'block';
                        document.getElementById('li-tab-karyawan').style.display = 'block';
                        document.getElementById('li-tab-login').style.display = 'block'; 
                        switchTab('data-absen'); // Langsung buka halaman Laporan Absen
                        await fetchAdminData();
                    } else if (currentUserRole === 'Admin') {
                        document.getElementById('adminTabs').style.display = 'flex';
                        document.getElementById('li-tab-data-absen').style.display = 'none';
                        document.getElementById('li-tab-karyawan').style.display = 'block';
                        document.getElementById('li-tab-login').style.display = 'none'; 
                        switchTab('karyawan'); 
                        await fetchAdminData();
                    } else {
                        document.getElementById('adminTabs').style.display = 'none';
                        switchTab('absen'); 
                        await fetchDataPendukung();
                    }

                } else { 
                    throw new Error(result.message); 
                }
            } catch (error) {
                if(error.message.includes('Unexpected') || error.message.includes('fetch')) {
                    errorDiv.textContent = "Koneksi gagal. Pastikan URL Web App benar & Izin Deploy Apps Script adalah 'Anyone'.";
                } else {
                    errorDiv.textContent = error.message;
                }
                errorDiv.classList.remove('d-none');
            } finally {
                btn.disabled = false;
                btn.innerHTML = '<i class="bi bi-box-arrow-in-right me-2"></i> Masuk';
            }
        });

        function logout() {
            document.getElementById('loginForm').reset();
            document.getElementById('absenForm').reset();
            document.getElementById('appContainer').style.display = 'none';
            document.getElementById('loginContainer').style.display = 'block';
            
            // Bersihkan data dan navigasi
            document.getElementById('adminTabs').style.display = 'none';
            document.getElementById('sec-absen').classList.add('d-none');
            document.getElementById('sec-karyawan').classList.add('d-none');
            document.getElementById('sec-login').classList.add('d-none');
            document.getElementById('sec-data-absen').classList.add('d-none');
        }

        // ==========================================
        // 2. FETCH DATA UNTUK ABSENSI
        // ==========================================
        async function fetchDataPendukung() {
            showLoading("Memuat data formulir...");
            try {
                const response = await fetch(scriptURL, { 
                    method: 'POST', 
                    headers: { 'Content-Type': 'text/plain;charset=utf-8' },
                    body: JSON.stringify({ action: 'getData' }) 
                });
                const result = await response.json();
                
                if (result.status === "success") {
                    globalKaryawanList = result.karyawan;
                    
                    // Masukkan ke datalist NAMA Karyawan
                    const namaList = document.getElementById('namaList');
                    namaList.innerHTML = '';
                    globalKaryawanList.forEach(emp => {
                        const option = document.createElement('option');
                        option.value = emp.nama; 
                        namaList.appendChild(option);
                    });
                    
                    const statusSelect = document.getElementById('Status_Absensi');
                    statusSelect.innerHTML = '<option value="" disabled selected>-- Pilih Status --</option>';
                    result.statusAbsensi.forEach(status => {
                        const option = document.createElement('option');
                        option.value = status; option.text = status;
                        statusSelect.appendChild(option);
                    });
                } else {
                    showAlert("Gagal mengambil data dari server: " + result.message);
                }
            } catch (error) { 
                let msg = error.message;
                if(msg.includes('fetch')) msg = "Koneksi ke server terputus. Pastikan kode Apps Script sudah diperbarui.";
                showAlert("Kesalahan API (getData): " + msg);
                console.error(error);
            } finally { hideLoading(); }
        }

        // Auto-fill Absensi Berdasarkan Nama Karyawan
        document.getElementById('nama').addEventListener('input', function() {
            const inputVal = this.value.toLowerCase();
            const found = globalKaryawanList.find(emp => emp.nama.toLowerCase() === inputVal);
            
            if (found) {
                document.getElementById('Badge').value = found.badge;
                document.getElementById('Jabatan').value = found.jabatan;
                document.getElementById('no_hp').value = found.no_hp;
                this.classList.add('is-valid');
            } else {
                document.getElementById('Badge').value = "";
                document.getElementById('Jabatan').value = "";
                document.getElementById('no_hp').value = "";
                this.classList.remove('is-valid');
            }
        });

        // ==========================================
        // 3. FETCH ADMIN DATA (CRUD & REKAP ABSEN)
        // ==========================================
        async function fetchAdminData() {
            showLoading("Memuat Database...");
            try {
                const response = await fetch(scriptURL, { 
                    method: 'POST', 
                    headers: { 'Content-Type': 'text/plain;charset=utf-8' },
                    body: JSON.stringify({ action: 'getAdminData' }) 
                });
                const result = await response.json();
                if (result.status === "success") {
                    adminKaryawanData = result.karyawan || [];
                    adminLoginData = result.login || [];
                    adminAbsensiData = result.absensi || []; // Ambil data absensi
                    
                    renderKaryawanTable();
                    renderLoginTable();
                    renderAbsensiTable(); // Tampilkan tabel absensi
                } else {
                    showAlert("Error memuat database: " + result.message);
                }
            } catch (error) { 
                let msg = error.message;
                if(msg.includes('fetch')) msg = "Koneksi terputus. Pastikan kode Backend Apps Script sudah diperbarui dengan versi terbaru.";
                showAlert("Kesalahan API (getAdminData): " + msg);
            } finally { hideLoading(); }
        }

        function renderAbsensiTable() {
            const tbody = document.getElementById('tbodyAbsensi');
            tbody.innerHTML = '';
            if(adminAbsensiData.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" class="text-center text-muted">Belum ada data absensi/Backend Apps Script belum diupdate</td></tr>';
                return;
            }

            adminAbsensiData.forEach((row) => {
                if(row[0] === "") return;
                const lat = row[6] ? row[6].toString().trim() : '';
                const lng = row[7] ? row[7].toString().trim() : '';
                
                let location = '-';
                if(lat && lng && lat !== '-' && lng !== '-') {
                    location = `<a href="https://www.google.com/maps/search/?api=1&query=${lat},${lng}" target="_blank" class="badge bg-info text-decoration-none"><i class="bi bi-geo-alt"></i> Cek Map</a>`;
                }

                // Warna badge status absensi
                let statusBadge = 'bg-secondary';
                if(row[8] === 'Hadir') statusBadge = 'bg-success';
                else if(row[8] === 'Izin' || row[8] === 'Terlambat') statusBadge = 'bg-warning text-dark';
                else if(row[8] === 'Sakit') statusBadge = 'bg-primary';
                else if(row[8] === 'Tanpa Keterangan') statusBadge = 'bg-danger';

                tbody.innerHTML += `
                    <tr>
                        <td class="small">${row[1]}</td>
                        <td><strong>${row[4]}</strong></td>
                        <td>${row[2]}</td>
                        <td>${row[5]}</td>
                        <td><span class="badge ${statusBadge}">${row[8] || '-'}</span></td>
                        <td>${location}</td>
                    </tr>`;
            });
        }

        function renderKaryawanTable() {
            const tbody = document.getElementById('tbodyKaryawan');
            tbody.innerHTML = '';
            adminKaryawanData.forEach((row, index) => {
                if(row[0] === "") return; 
                tbody.innerHTML += `
                    <tr>
                        <td><strong>${row[0]}</strong></td>
                        <td>${row[1]}</td>
                        <td>${row[4]}</td>
                        <td>${row[10]}</td>
                        <td>
                            <button class="btn btn-sm btn-outline-primary py-0" onclick="openModalKaryawan('edit', ${index})"><i class="bi bi-pencil"></i></button>
                            <button class="btn btn-sm btn-outline-danger py-0" onclick="deleteKaryawan('${row[0]}')"><i class="bi bi-trash"></i></button>
                        </td>
                    </tr>`;
            });
        }

        function renderLoginTable() {
            const tbody = document.getElementById('tbodyLogin');
            tbody.innerHTML = '';
            adminLoginData.forEach((row, index) => {
                if(row[0] === "") return;
                tbody.innerHTML += `
                    <tr>
                        <td><strong>${row[0]}</strong></td>
                        <td>${row[1]}</td>
                        <td>${row[2]}</td>
                        <td><span class="badge bg-secondary">${row[3]}</span></td>
                        <td>
                            <button class="btn btn-sm btn-outline-primary py-0" onclick="openModalLogin('edit', ${index})"><i class="bi bi-pencil"></i></button>
                            <button class="btn btn-sm btn-outline-danger py-0" onclick="deleteLogin('${row[0]}')"><i class="bi bi-trash"></i></button>
                        </td>
                    </tr>`;
            });
        }

        // ==========================================
        // 4. CRUD ACTIONS KARYAWAN
        // ==========================================
        function openModalKaryawan(method, index = null) {
            document.getElementById('formKaryawan').reset();
            document.getElementById('kar_action_method').value = method;
            document.getElementById('kar_badge').readOnly = (method === 'edit');
            
            // Mengosongkan data dan pratinjau gambar saat membuka form
            document.getElementById('kar_fotoKtp_base64').value = "";
            document.getElementById('kar_fotoKk_base64').value = "";
            document.getElementById('kar_fotoKtp_preview').classList.add('d-none');
            document.getElementById('kar_fotoKk_preview').classList.add('d-none');
            
            if(method === 'edit') {
                const row = adminKaryawanData[index];
                document.getElementById('modalKaryawanTitle').textContent = 'Edit Karyawan';
                document.getElementById('kar_old_badge').value = row[0];
                document.getElementById('kar_badge').value = row[0];
                document.getElementById('kar_nama').value = row[1];
                document.getElementById('kar_jk').value = row[2];
                document.getElementById('kar_statusKerja').value = row[3];
                document.getElementById('kar_jabatan').value = row[4];
                document.getElementById('kar_statusNikah').value = row[5];
                document.getElementById('kar_nik').value = row[6];
                document.getElementById('kar_kk').value = row[7];
                
                // Set data foto jika sudah ada di database
                document.getElementById('kar_fotoKtp_base64').value = row[8];
                if(row[8] && row[8].toString().trim() !== "") {
                    document.getElementById('kar_fotoKtp_preview').innerHTML = '<i class="bi bi-check-circle-fill"></i> Data foto sudah ada';
                    document.getElementById('kar_fotoKtp_preview').classList.remove('d-none', 'text-primary');
                    document.getElementById('kar_fotoKtp_preview').classList.add('text-success');
                }

                document.getElementById('kar_fotoKk_base64').value = row[9];
                if(row[9] && row[9].toString().trim() !== "") {
                    document.getElementById('kar_fotoKk_preview').innerHTML = '<i class="bi bi-check-circle-fill"></i> Data foto sudah ada';
                    document.getElementById('kar_fotoKk_preview').classList.remove('d-none', 'text-primary');
                    document.getElementById('kar_fotoKk_preview').classList.add('text-success');
                }

                document.getElementById('kar_hp').value = row[10];
                document.getElementById('kar_ket').value = row[11];
            } else {
                document.getElementById('modalKaryawanTitle').textContent = 'Tambah Karyawan';
            }
            mkModal.show();
        }

        async function saveKaryawan() {
            const method = document.getElementById('kar_action_method').value;
            const badge = document.getElementById('kar_badge').value;
            const nama = document.getElementById('kar_nama').value;
            if(!badge || !nama) return showAlert('Badge & Nama wajib diisi!');

            const payload = {
                action: 'crudKaryawan', method: method, id_badge: document.getElementById('kar_old_badge').value,
                rowData: {
                    badge: badge, nama: nama,
                    jk: document.getElementById('kar_jk').value,
                    statusKerja: document.getElementById('kar_statusKerja').value,
                    jabatan: document.getElementById('kar_jabatan').value,
                    statusNikah: document.getElementById('kar_statusNikah').value,
                    nik: document.getElementById('kar_nik').value,
                    noKk: document.getElementById('kar_kk').value,
                    fotoKtp: document.getElementById('kar_fotoKtp_base64').value, // Ambil base64 hasil kompresi
                    fotoKk: document.getElementById('kar_fotoKk_base64').value,   // Ambil base64 hasil kompresi
                    hp: document.getElementById('kar_hp').value,
                    ket: document.getElementById('kar_ket').value
                }
            };
            
            mkModal.hide(); showLoading("Menyimpan Data Karyawan...");
            try {
                await fetch(scriptURL, { 
                    method: 'POST', 
                    headers: { 'Content-Type': 'text/plain;charset=utf-8' },
                    body: JSON.stringify(payload) 
                });
                await fetchAdminData();
            } catch (err) {
                hideLoading();
                showAlert("Gagal menyimpan. Cek kembali koneksi internet Anda.");
            }
        }

        async function deleteKaryawan(id_badge) {
            if(confirm('Yakin ingin menghapus Karyawan dengan Badge: ' + id_badge + '?')) {
                showLoading("Menghapus Data...");
                try {
                    await fetch(scriptURL, { 
                        method: 'POST', 
                        headers: { 'Content-Type': 'text/plain;charset=utf-8' },
                        body: JSON.stringify({ action: 'crudKaryawan', method: 'delete', id_badge: id_badge }) 
                    });
                    await fetchAdminData();
                } catch(err) {
                    hideLoading();
                    showAlert("Gagal menghapus data.");
                }
            }
        }

        // ==========================================
        // 5. CRUD ACTIONS LOGIN
        // ==========================================
        function openModalLogin(method, index = null) {
            document.getElementById('formLogin').reset();
            document.getElementById('log_action_method').value = method;
            document.getElementById('log_id').readOnly = (method === 'edit');
            
            if(method === 'edit') {
                const row = adminLoginData[index];
                document.getElementById('modalLoginTitle').textContent = 'Edit Akun Login';
                document.getElementById('log_old_id').value = row[0];
                document.getElementById('log_id').value = row[0];
                document.getElementById('log_username').value = row[1];
                document.getElementById('log_password').value = row[2];
                document.getElementById('log_role').value = row[3];
            } else {
                document.getElementById('modalLoginTitle').textContent = 'Tambah Akun Login';
            }
            mlModal.show();
        }

        async function saveLogin() {
            const method = document.getElementById('log_action_method').value;
            const id = document.getElementById('log_id').value;
            const user = document.getElementById('log_username').value;
            if(!id || !user) return showAlert('ID & Username wajib diisi!');

            const payload = {
                action: 'crudLogin', method: method, id_login: document.getElementById('log_old_id').value,
                rowData: {
                    id: id, username: user,
                    password: document.getElementById('log_password').value,
                    role: document.getElementById('log_role').value
                }
            };
            
            mlModal.hide(); showLoading("Menyimpan Data Akses...");
            try {
                await fetch(scriptURL, { 
                    method: 'POST', 
                    headers: { 'Content-Type': 'text/plain;charset=utf-8' },
                    body: JSON.stringify(payload) 
                });
                await fetchAdminData();
            } catch(err) {
                hideLoading();
                showAlert("Gagal menyimpan akses login.");
            }
        }

        async function deleteLogin(id_login) {
            if(confirm('Yakin ingin menghapus Akses Login dengan ID: ' + id_login + '?')) {
                showLoading("Menghapus Akses...");
                try {
                    await fetch(scriptURL, { 
                        method: 'POST', 
                        headers: { 'Content-Type': 'text/plain;charset=utf-8' },
                        body: JSON.stringify({ action: 'crudLogin', method: 'delete', id_login: id_login }) 
                    });
                    await fetchAdminData();
                } catch(err) {
                    hideLoading();
                    showAlert("Gagal menghapus akses.");
                }
            }
        }

        // ==========================================
        // 6. FUNGSI GPS DAN KIRIM ABSEN (DEFAULT)
        // ==========================================
        function getLocation() {
            const statusText = document.getElementById('locationStatus');
            statusText.classList.remove('d-none', 'text-danger', 'text-success');
            statusText.classList.add('text-primary');
            statusText.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span> Mencari lokasi GPS...';

            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    (pos) => {
                        document.getElementById('Latitude').value = pos.coords.latitude;
                        document.getElementById('Langtitude').value = pos.coords.longitude;
                        statusText.classList.replace('text-primary', 'text-success');
                        statusText.innerHTML = '<i class="bi bi-check-circle-fill"></i> Lokasi ditemukan!';
                    },
                    (err) => {
                        statusText.classList.replace('text-primary', 'text-danger');
                        statusText.innerHTML = '<i class="bi bi-exclamation-triangle-fill"></i> Gagal mengambil lokasi.';
                    }, { enableHighAccuracy: true }
                );
            }
        }

        document.getElementById('absenForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            // Validasi berdasarkan field Badge, karena kalau nama benar maka Badge pasti terisi otomatis
            if (document.getElementById('Badge').value === "") return showAlert("Nama Karyawan tidak valid. Ketik dan pilih Nama dari daftar.");

            const btnSubmit = document.getElementById('btnSubmitAbsen');
            const statusMsg = document.getElementById('statusMessage');
            btnSubmit.disabled = true; statusMsg.classList.add('d-none');

            const payload = {
                action: 'absen',
                Badge: document.getElementById('Badge').value,
                nama: document.getElementById('nama').value,
                Jabatan: document.getElementById('Jabatan').value,
                no_hp: document.getElementById('no_hp').value,
                Status_Absensi: document.getElementById('Status_Absensi').value,
                Latitude: document.getElementById('Latitude').value,
                Langtitude: document.getElementById('Langtitude').value
            };

            try {
                const response = await fetch(scriptURL, { 
                    method: 'POST', 
                    headers: { 'Content-Type': 'text/plain;charset=utf-8' },
                    body: JSON.stringify(payload) 
                });
                const result = await response.json();
                if (result.status === "success") {
                    statusMsg.className = "alert alert-success mt-3 text-center";
                    statusMsg.innerHTML = '<i class="bi bi-check-circle-fill"></i> Berhasil! Data kehadiran terkirim.';
                    document.getElementById('absenForm').reset();
                    document.getElementById('nama').classList.remove('is-valid');
                    document.getElementById('locationStatus').classList.add('d-none');
                } else throw new Error(result.message);
            } catch (error) {
                statusMsg.className = "alert alert-danger mt-3 text-center";
                statusMsg.innerHTML = '<i class="bi bi-exclamation-triangle-fill"></i> Gagal! ' + error.message;
            } finally { btnSubmit.disabled = false; }
        });
    </script>
</body>
</html>